{{- /* Optimized JavaScript Loading with Code Splitting */}}

{{- /* Core scripts - always loaded */}}
{{ $main := resources.Get "js/main.js" }}
{{ $menu := resources.Get "js/menu.js" }}

{{- /* Bundle core scripts */}}
{{ $coreJS := slice $main $menu | resources.Concat "js/core.js" | resources.Minify | resources.Fingerprint "sha512" }}
<script type="text/javascript" src="{{ $coreJS.RelPermalink }}" integrity="{{ $coreJS.Data.Integrity }}" defer></script>

{{- /* Prism.js - only load on pages with code blocks */}}
{{- $hasCode := false -}}
{{- if .HasShortcode "highlight" -}}
    {{- $hasCode = true -}}
{{- end -}}
{{- /* Also check for fenced code blocks in content */}}
{{- if findRE "```" .RawContent -}}
    {{- $hasCode = true -}}
{{- end -}}
{{- if findRE "<pre><code" .Content -}}
    {{- $hasCode = true -}}
{{- end -}}

{{- if $hasCode -}}
{{ $prism := resources.Get "js/prism.js" }}
{{ if $prism }}
{{ $prismJS := $prism | resources.Minify | resources.Fingerprint "sha512" }}
<script type="text/javascript" src="{{ $prismJS.RelPermalink }}" integrity="{{ $prismJS.Data.Integrity }}" defer></script>
{{ end }}
{{- end -}}

{{- /* TOC script - load when page has a table of contents */}}
{{- $hasToc := and (ne .TableOfContents "") (gt (len .TableOfContents) 100) -}}
{{- if or .Params.toc $hasToc -}}
{{ $toc := resources.Get "js/toc.js" }}
{{ if $toc }}
{{ $tocJS := $toc | resources.Minify | resources.Fingerprint "sha512" }}
<script type="text/javascript" src="{{ $tocJS.RelPermalink }}" integrity="{{ $tocJS.Data.Integrity }}" defer></script>
{{ end }}

{{/* Mobile ToC toggle */}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var toggle = document.getElementById('toc-mobile-toggle');
    var content = document.getElementById('toc-mobile-content');
    var chevron = document.getElementById('toc-mobile-chevron');
    if (!toggle || !content) return;

    toggle.addEventListener('click', function() {
        var expanded = content.classList.toggle('expanded');
        chevron && chevron.classList.toggle('expanded', expanded);
        toggle.setAttribute('aria-expanded', expanded);
        content.setAttribute('aria-hidden', !expanded);
    });

    // Collapse after clicking a ToC link
    content.querySelectorAll('a').forEach(function(link) {
        link.addEventListener('click', function() {
            content.classList.remove('expanded');
            chevron && chevron.classList.remove('expanded');
            toggle.setAttribute('aria-expanded', 'false');
            content.setAttribute('aria-hidden', 'true');
        });
    });
});
</script>
{{- end -}}

{{- /* Custom JS */}}
{{ range $val := $.Site.Params.customJS }}
    {{ if gt (len $val) 0 }}
        <script src="{{ $val }}" defer></script>
    {{ end }}
{{ end }}

{{- /* Mermaid - only load when page has mermaid diagrams */}}
{{ if .Page.Store.Get "hasMermaid" }}
<script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs";
    const settings = localStorage.getItem("theme") === "dark" ?
        {
            startOnLoad: true,
            theme: "dark",
            darkMode: true,
            themeVariables: {
                tertiaryColor: "#dee3ed"
            }
        }
        :
        {
            startOnLoad: true,
            theme: "base",
            darkMode: false,
            themeVariables: {
                tertiaryColor: "#dee3ed"
            }
        }
    ;
    mermaid.initialize(settings);
</script>
{{ end }}
